name: CI

on:
  push:
    branches: [master]
  pull_request:

permissions:
  contents: read

jobs:
  local-check:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache/CodeQL
          df -h
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0
          components: clippy,rustfmt
      - uses: Swatinem/rust-cache@v2
      - run: ./ci/local_check.sh

  build:
    runs-on: ubuntu-latest
    needs: [local-check]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0
          components: clippy,rustfmt
      - name: Ensure cargo-binstall is installed
        run: |
          if ! command -v cargo-binstall >/dev/null; then
            cargo install --locked cargo-binstall
          fi
      - name: Install greentic CLIs
        run: cargo binstall --force greentic-component greentic-flow greentic-pack
      - run: ./ci/gen_packs.sh
      - uses: actions/upload-artifact@v4
        with:
          name: dist-packs
          path: dist/*.gtpack

  doctor:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0
          components: clippy,rustfmt
      - name: Ensure cargo-binstall is installed
        run: |
          if ! command -v cargo-binstall >/dev/null; then
            cargo install --locked cargo-binstall
          fi
      - name: Install greentic-pack CLI
        run: cargo binstall --force greentic-pack
      - uses: actions/download-artifact@v4
        with:
          name: dist-packs
          path: dist
      - run: |
          for pack in dist/*.gtpack; do
            greentic-pack doctor --pack "$pack"
          done

  smoke:
    runs-on: ubuntu-latest
    needs: [doctor]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0
          components: clippy,rustfmt
      - run: ./ci/smoke_deployer.sh

  publish:
    runs-on: ubuntu-latest
    needs: [smoke]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist-packs
          path: dist
      - uses: cli/gh-action@v2
        with:
          version: latest
      - name: Publish dist packs to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$TAG" --notes "CLI-built placeholder packs"
          fi
          gh release upload "$TAG" dist/*.gtpack --clobber

  deploy:
    runs-on: ubuntu-latest
    needs: local-check
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
    steps:
      - name: Start deploy after CI success
        run: echo "Deploy started (CI passed on master)"
