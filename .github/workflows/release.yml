name: Publish

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types:
      - completed
  workflow_dispatch:

jobs:
  crate-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0
          components: clippy,rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          publish_output=$(cargo publish --locked 2>&1) || status=$?
          echo "$publish_output"
          if [ "${status:-0}" -ne 0 ]; then
            if echo "$publish_output" | grep -qi "already uploaded"; then
              echo "Version already published; skipping error."
              exit 0
            fi
            if echo "$publish_output" | grep -qi "already exists on crates.io index"; then
              echo "Crate version already on crates.io; skipping publish error."
              exit 0
            fi
            exit ${status:-1}
          fi

  dist:
    name: Build release binaries (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    needs: crate-publish
    strategy:
        matrix:
            include:
              - os: ubuntu-latest
                target: x86_64-unknown-linux-gnu
              - os: macos-15-intel
                target: x86_64-apple-darwin
              - os: macos-latest
                target: aarch64-apple-darwin
              - os: windows-latest
                target: x86_64-pc-windows-msvc
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      CARGO_HOME: ${{ github.workspace }}/.cargo-${{ github.job }}-${{ github.run_id }}
      CARGO_TARGET_DIR: ${{ github.workspace }}/.target-${{ github.job }}-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build and package ${{ matrix.target }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata --format-version 1 --no-deps | python -c 'import json,sys; data=json.load(sys.stdin); print(next(p["version"] for p in data["packages"] if p.get("name")=="greentic-deployer"))')
          TARGET="${{ matrix.target }}"
          ARTIFACT_DIR="dist"
          STAGING="$ARTIFACT_DIR/greentic-deployer-v${VERSION}-${TARGET}"

          cargo fetch --locked --target "$TARGET"
          cargo build --locked --release --target "$TARGET"

          BIN_EXT=""
          if [[ "$TARGET" == *windows* ]]; then
            BIN_EXT=".exe"
          fi

          mkdir -p "$STAGING"
          cp "$CARGO_TARGET_DIR/$TARGET/release/greentic-deployer${BIN_EXT}" "$STAGING/"
          if [[ -f "$CARGO_TARGET_DIR/$TARGET/release/gen_example_manifests${BIN_EXT}" ]]; then
            cp "$CARGO_TARGET_DIR/$TARGET/release/gen_example_manifests${BIN_EXT}" "$STAGING/"
          fi
          cp README.md LICENSE "$STAGING/" || true

          tar czf "$STAGING.tgz" -C "$STAGING" .

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: greentic-deployer-${{ matrix.target }}
          path: dist/greentic-deployer-v*-${{ matrix.target }}.tgz
          if-no-files-found: error

  release:
    name: GitHub Release
    needs: [crate-publish, dist]
    if: needs.crate-publish.result == 'success' && needs.dist.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.90.0

      - name: Compute crate version
        id: version
        run: |
          VERSION=$(cargo metadata --format-version 1 --no-deps | python -c 'import json,sys; data=json.load(sys.stdin); print(next(p["version"] for p in data["packages"] if p.get("name")=="greentic-deployer"))')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List release assets
        run: ls -R dist

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: greentic-deployer v${{ steps.version.outputs.version }}
          files: dist/**/*.tgz
          generate_release_notes: true
